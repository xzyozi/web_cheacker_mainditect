### ページネーション対応の改善案

現在のシステムは、`cheacker_url.jsonl`に登録された各URLを独立した監視対象として扱っており、ページネーション（複数ページにわたるコンテンツ）を自動的に検出・追跡する機能は持っていません。そのため、ユーザーが手動で`page=1`, `page=2`といったURLを登録している場合、それぞれのページが個別に監視され、更新の検出が意図しない挙動を示す可能性があります。

この問題を解決し、ページネーションされたコンテンツの更新を正確に追跡するために、以下の改善案を提案します。

#### 1. ページネーション検出とURL収集機能の追加

**目的:** 監視対象のURLがページネーションされたシリーズの一部である場合、そのシリーズ内のすべての関連URLを自動的に発見し、監視対象に含める。

**実装案:**
*   **設定の追加:** `config.yaml`または`cheacker_url.jsonl`の各URLエントリに、ページネーション検出を有効にするフラグや、ページネーションのパターン（CSSセレクタ、URLパターンなど）を指定するオプションを追加します。
*   **ページネーション検出ロジック:**
    *   **CSSセレクタによる検出:** Playwrightを使用して、"次へ"ボタン、ページ番号リンク（例: `<a class="next-page">`, `<li class="page-item">`）などの特定のCSSセレクタを探索します。
    *   **URLパターンによる推測:** `?page=N`, `/page/N`, `_p=N`のような一般的なURLパターンを解析し、次のページURLを推測します。
    *   **再帰的な探索:** 発見した次のページURLを辿り、さらにそのページから次のページを探索することで、シリーズ内のすべてのページURLを収集します。
*   **URLの正規化と重複排除:** 収集したURLは、クエリパラメータの順序などを正規化し、重複を排除して一意なURLリストを作成します。

#### 2. ページネーションシリーズの管理

**目的:** ページネーションされた複数のURLを、論理的に一つの「コンテンツシリーズ」として扱い、そのシリーズ全体の更新を監視する。

**実装案:**
*   **`DataManager`の拡張:**
    *   `cheacker_url.jsonl`のデータ構造を拡張し、各URLがどの「ページネーションシリーズ」に属するかを示す`series_id`のようなフィールドを追加します。
    *   シリーズの「親URL」（最初のページなど）を定義し、その親URLに関連するすべてのページURLを管理します。
*   **更新検出ロジックの変更:**
    *   シリーズ内のいずれかのページでコンテンツの変更が検出された場合、そのシリーズ全体が「更新された」と判断します。
    *   新しいページがシリーズに追加された場合（例: `page=3`が新しく公開された場合）も、更新として検出します。
    *   既存のページがシリーズから削除された場合も検出できるようにします。

#### 3. コンテンツ抽出の精度向上と重複コンテンツの除外

**目的:** 各ページから、ヘッダー、フッター、サイドバーなど、ページ間で重複する可能性のある要素を除外し、そのページ固有のメインコンテンツのみを正確に抽出する。

**実装案:**
*   **`trafilatura`の活用:** 以前提案した`trafilatura`のような専門ライブラリは、本文抽出に特化しており、定型的な要素を自動的に除外する機能を持っています。これを活用することで、ページ固有のコンテンツ抽出精度を大幅に向上させることができます。
*   **共通要素の特定と除外:**
    *   シリーズ内の複数のページをスキャンし、共通して出現するDOM要素（CSSセレクタやHTML構造で特定）を特定します。
    *   これらの共通要素をコンテンツ比較の対象から除外するルールを追加します。
*   **コンテンツハッシュの粒度:** ページ全体のハッシュではなく、抽出されたメインコンテンツブロックのハッシュのみを比較することで、不要な変更検出を減らします。

#### 導入のステップ

1.  **フェーズ1: ページネーション検出とURL収集のPoC (Proof of Concept)**
    - 既存の監視ロジックに影響を与えずに、指定されたURLからページネーションリンクを辿り、関連URLを収集する独立したモジュールを作成します。
    - 収集したURLリストをログに出力し、検出精度を確認します。

2.  **フェーズ2: `DataManager`とスキャンロジックの統合**
    - 収集したURLを`DataManager`が管理できるようにデータ構造を拡張します。
    - `process_url_async`が、単一URLだけでなく、必要に応じてシリーズ内の他のURLも考慮するように変更します。

3.  **フェーズ3: コンテンツ抽出の改善とテスト**
    - `trafilatura`の導入、または共通要素の除外ロジックを実装し、ページネーションされたサイトでの誤検出が減少するかをテストします。

この改善により、ページネーションされたWebサイトの更新監視がより正確かつ効率的になり、ユーザーの利便性が向上します。