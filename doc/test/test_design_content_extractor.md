# `content_extractor` モジュール テスト設計書

## 1. 目的

`pytest`フレームワークを導入し、`content_extractor`モジュールの主要な機能に対するユニットテストおよびインテグレーションテストを整備する。これにより、コードの品質、正確性、堅牢性を担保し、将来のリファクタリングや機能追加を安全に行えるようにする。

## 2. 方針

### 2.1. 全体方針

- **テストフレームワーク:** `pytest` を使用する。非同期処理のテストには `pytest-asyncio` を利用する。
- **モック:** Playwrightや外部APIへの依存を切り離すため、`unittest.mock` を用いてモックオブジェクトを使用する。
- **テスト範囲:**
    - **ユニットテスト:** 計算ロジックやデータ変換など、単体で完結する純粋な関数を中心にテストする。
    - **インテグレーションテスト:** 複数のコンポーネントが連携するフロー（特に`core.py`）を対象とし、主要な機能を模倣（モック）しながら全体の流れを検証する。

### 2.2. テスト対象とテスト観点

#### a. `scorer.py` (ユニットテスト)

- **対象:** スコアリング計算ロジック
- **観点:**
    - `calc_text_density`, `calc_position_score` などの各スコア計算関数が、期待される入力に対して正しいスコアを算出するか。
    - テキストがない、サイズがゼロなど、エッジケースのDOMノードを正しく処理できるか。
    - `find_candidates` がスコアに基づいて適切に候補をランキングできるか。

#### b. `quality_evaluator.py` (ユニットテスト)

- **対象:** 検索結果の品質評価ロジック
- **観点:**
    - `_is_valid_result_item` が、リンクの有無やテキスト量に基づき、有効な検索結果アイテムを正しく判定できるか。
    - `quantify_search_results` が、DOMツリーから結果アイテムを正しく抽出し、カウントできるか。
    - `is_no_results_page` が、モック化したページオブジェクトを使い、「結果なし」ページを正しく判定できるか。

#### c. `relevance_scorer.py` (ユニットテスト)

- **対象:** 関連性スコアの計算ロジック
- **観点:**
    - `calculate_sqs` が、入力された各種指標（結果件数、関連性スコア平均など）から、期待される品質スコア（SQS）を算出できるか。
    - `score_relevance` のテストは、`sentence-transformers`モデルへの依存が大きいため、モデル部分をモック化するか、ごく小規模なテストデータで動作確認を行う。

#### d. `dom_utils.py` / `web_type_chk.py` (ユニットテスト)

- **対象:** DOM操作、URL判定ロジック
- **観点:**
    - `rescore_main_content_with_children` が、親子関係にあるDOMノードのスコアを正しく再計算できるか。
    - `webtype_chk` が、URLのパターンやDOMの構造に基づき、Webページのタイプを正しく判定できるか。

#### e. `core.py` (インテグレーションテスト)

- **対象:** コンテンツ抽出のメインフロー
- **観点:**
    - **`extract_main_content`:**
        - `make_tree` や `scorer` などの内部モジュールをモック化し、コンテンツ絞り込みの`while`ループが期待通りに動作するか（スコアに応じて正しく終了するか）を検証する。
        - ページ遷移が検知された場合に、再帰呼び出しが行われることを確認する。
    - **`quick_extract_content`:**
        - Playwrightのページオブジェクトをモック化し、提供されたCSSセレクタリストを順番に試し、成功・失敗のロジックが正しいかを検証する。

## 3. テストデータ

- ユニットテストには、`DOMTreeSt`を模した小規模なPythonオブジェクト（フィクスチャ）を利用する。
- 必要に応じて、テスト用の単純なHTMLファイルを用意し、`make_tree`の入力として使用する。

## 4. 実行方法

プロジェクトのルートディレクトリで以下のコマンドを実行し、テストを起動する。

```bash
pytest
```
